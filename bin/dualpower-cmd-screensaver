#!/bin/bash
# Adapted from https://github.com/basecamp/dualpower/blob/master/bin/omarchy-cmd-screensaver
#
screensaver_in_focus() {
# FIXME niri
  #hyprctl activewindow -j | jq -e '.class == "org.dualpower.screensaver"' >/dev/null 2>&1
  #niri msg action full-screenwindow
  true
}


# an experience
sleep 0.25s

windowId=$(niri msg windows | grep -n -2 dualpower.screensaver | grep 'Window ID' | sed -r 's/.*Window ID ([0-9]+).*$/\1/')

niri msg action fullscreen-window --id $windowId
niri msg action focus-window --id $windowId;

exit_screensaver() {
# FIXME niri
  pkill -x tte 2>/dev/null
  pkill -f org.dualpower.screensaver 2>/dev/null
  exit 0
}

# Exit the screensaver on signals and input from keyboard and mouse
trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT
printf '\e[?1000h\e[?1003h' # Enable mouse tracking (clicks: 1000, movement: 1003)
while read -rsn1 -t 0.1; do :; done # Flush any pending input

printf '\033]11;rgb:00/00/00\007'  # Set background color to black

# FIXME niri

tty=$(tty 2>/dev/null)

while true; do
  tte -i ~/.config/dualpower/logo.txt \
    --frame-rate 60 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c\
    --random-effect --exclude-effects dev_worm \
    --no-eol --no-restore-cursor &

  while pgrep -t "${tty#/dev/}" -x tte >/dev/null; do
    if read -rsn1 -t 1 || ! screensaver_in_focus; then
      exit_screensaver
    fi
  done
done

